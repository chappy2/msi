// Generated by CoffeeScript 1.9.3
var Film, FilmList, FilmListView, app, filmList, re, removeSpace,
  bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

re = new RegExp(/[ \?]/, 'g');

removeSpace = function(input) {
  return input.replace(re, '');
};

Film = (function() {
  function Film(values) {
    var success;
    success = this.setAttributes(values);
    if (success) {
      this.id = removeSpace(values.title + values.year);
    }
  }

  Film.prototype.validate = function(values) {
    return true;
  };

  Film.prototype.setAttributes = function(values) {
    if (this.validate(values)) {
      this.attributes = values;
      return true;
    }
    return false;
  };

  return Film;

})();

FilmList = (function() {
  function FilmList() {
    this.storageName = 'demoMoviedatabaseCollection';
    this.fetch();
    this;
  }

  FilmList.prototype.newFilm = function(values, callback) {
    var checkExisting, elem, futureId;
    futureId = removeSpace(values.title + values.year);
    checkExisting = this.getFilm(futureId);
    if ((checkExisting == null) || checkExisting.length >= 1) {
      if (typeof callback === "function") {
        callback();
      }
      return false;
    }
    elem = new Film(values);
    this.collection.push(elem);
    this.save(callback);
    return true;
  };

  FilmList.prototype.removeFilm = function(ids, callback) {
    var film;
    this.collection = (function() {
      var i, len, ref, results;
      ref = this.collection;
      results = [];
      for (i = 0, len = ref.length; i < len; i++) {
        film = ref[i];
        if (film.id !== ids) {
          results.push(film);
        }
      }
      return results;
    }).call(this);
    return this.save(callback);
  };

  FilmList.prototype.getFilm = function(ids) {
    var film, result;
    result = (function() {
      var i, len, ref, results;
      ref = this.collection;
      results = [];
      for (i = 0, len = ref.length; i < len; i++) {
        film = ref[i];
        if (film.id === ids) {
          results.push(film);
        }
      }
      return results;
    }).call(this);
    return result;
  };

  FilmList.prototype.getCollection = function() {
    return this.collection;
  };

  FilmList.prototype.fetch = function(callback) {
    var temp;
    temp = localStorage[this.storageName];
    if (temp == null) {
      this.collection = [];
      this.newFilm({
        year: 2018,
        title: 'le movie',
        director: 'derpington',
        fsk: '18',
        runtime: '2011-2015'
      });
    } else {
      this.collection = JSON.parse(temp);
    }
    return typeof callback === "function" ? callback() : void 0;
  };

  FilmList.prototype.save = function(callback) {
    localStorage[this.storageName] = JSON.stringify(this.getCollection());
    return typeof callback === "function" ? callback() : void 0;
  };

  FilmList.prototype.updateFilm = function(id, attribut, value) {
    var films;
    films = this.getFilm(id);
    films[0].attributes[attribut] = value;
    return films[0].id = removeSpace(films[0].attributes.title + films[0].attributes.year);
  };

  FilmList.prototype.sort = function(attribut, sorting) {
    var asc, desc;
    this.sorted = {
      attribut: attribut,
      sorting: sorting
    };
    asc = function(a, b) {
      if (a.attributes[attribut] < b.attributes[attribut]) {
        return -1;
      }
      if (a.attributes[attribut] > b.attributes[attribut]) {
        return 1;
      }
      return 0;
    };
    desc = function(a, b) {
      if (a.attributes[attribut] > b.attributes[attribut]) {
        return -1;
      }
      if (a.attributes[attribut] < b.attributes[attribut]) {
        return 1;
      }
      return 0;
    };
    if (sorting === "asc") {
      return this.collection = this.collection.sort(asc);
    } else {
      return this.collection = this.collection.sort(desc);
    }
  };

  return FilmList;

})();

FilmListView = (function() {
  function FilmListView(filmList) {
    this.render = bind(this.render, this);
    var dialogOptions;
    this.inputDirector = '#director';
    this.inputFsk = '#fsk';
    this.inputTitle = '#title';
    this.inputYear = '#year';
    this.inputRuntime = '#runtime';
    this.tbodyData = '#contentData';
    this.buttonSave = '#save-table';
    this.buttonCreate = '#create-film';
    this.classNotSaved = '.editable-unsaved';
    this.aSortTitle = '#sortTitle';
    this.aSortDirector = '#sortDirector';
    this.aSortFsk = '#sortfsk';
    this.aSortYear = '#sortYear';
    this.aSortRuntime = '#sortRuntime';
    this.sorted = ["", ""];
    this.filmList = filmList;
    this.render();
    $(this.inputFsk).on('keydown', (function(_this) {
      return function(event) {
        return _this.showDialogSave(_this.createOnEnter, event);
      };
    })(this));
    $(this.buttonCreate).on('click', (function(_this) {
      return function(event) {
        return _this.showDialogSave(_this.createFilm, event);
      };
    })(this));
    $(this.buttonSave).on('click', (function(_this) {
      return function(event) {
        return _this.saveFilmList(event, _this.render);
      };
    })(this));
    $(this.aSortTitle + "," + this.aSortDirector + "," + this.aSortYear + "," + this.aSortRuntime + "," + this.aSortFsk).on('click', (function(_this) {
      return function(event) {
        return _this.showDialogSave(_this.sort, event);
      };
    })(this));
    dialogOptions = {
      autoOpen: false,
      show: "blind",
      hide: "blind",
      modal: true
    };
    $("#dialog-invalid-input").dialog(dialogOptions);
    $("#dialog-already-exist").dialog(dialogOptions);
    $("#dialog-eidtable-not-saved").dialog(dialogOptions);
    $.fn.editable.defaults.mode = 'inline';
    this;
  }

  FilmListView.prototype.render = function() {

    /*
     render used as callback function (propagated trough FilmList localStorage interactions
     */
    var film, trString;
    trString = (function() {
      var i, len, ref, results;
      ref = this.filmList.getCollection();
      results = [];
      for (i = 0, len = ref.length; i < len; i++) {
        film = ref[i];
        results.push(this.renderFilm(film));
      }
      return results;
    }).call(this);
    $(this.tbodyData).empty();
    $(this.tbodyData).append(trString.join());
    this.addDeleteEvents();
    this.initXEditableFields();
    $("button").button();
    this.renderSaveButton();
    return this.renderSorting();
  };

  FilmListView.prototype.renderSorting = function() {
    var iconClass;
    if (this.sorted[0] !== "" && this.sorted[1] !== "") {
      $(".sort-asc,.sort-desc").each((function(_this) {
        return function(k, v) {
          v.setAttribute("class", "");
          return v.lastChild.setAttribute("class", "");
        };
      })(this));
      $(this.sorted[0]).attr("class", this.sorted[1]);
      iconClass = "ui-icon ui-icon-caret-1-";
      if (this.sorted[1] === "sort-asc") {
        iconClass = iconClass + "s";
      } else {
        iconClass = iconClass + "n";
      }
      return $(this.sorted[0] + ">span").attr("class", iconClass);
    }
  };

  FilmListView.prototype.renderSaveButton = function() {
    return $('.editable').on('click', (function(_this) {
      return function(event) {
        $('div').on('save', function(event) {
          return $(_this.buttonSave).button("enable");
        });
        return $(_this.buttonSave).button("disable");
      };
    })(this));
  };

  FilmListView.prototype.renderFilm = function(film) {
    var values;
    values = film.attributes;
    return "<tr id='" + film.id + "_row'>\n    <td><a href=\"#\" data-type=\"text\"  data-pk=\"" + film.id + "\"  data-title=\"Enter username\" id=\"" + film.id + "_title\">" + values.title + "</a></td>\n    <td><a href=\"#\" data-type=\"text\"  data-pk=\"" + film.id + "\"  data-title=\"Enter username\" id=\"" + film.id + "_director\">" + values.director + "</a></td>\n    <td><a href=\"#\" data-type=\"text\"  data-pk=\"" + film.id + "\"  data-title=\"Enter username\" id=\"" + film.id + "_year\">" + values.year + "</a></td>\n    <td><a href=\"#\" data-type=\"text\"  data-pk=\"" + film.id + "\"  data-title=\"Enter username\" id=\"" + film.id + "_runtime\">" + values.runtime + "</a></td>\n    <td><a href=\"#\" data-type=\"text\"  data-pk=\"" + film.id + "\"   data-title=\"Enter username\" id=\"" + film.id + "_fsk\">" + values.fsk + "</a></td>\n    <td><form>\n        <button  id='" + film.id + "'  class='ui-button ui-corner-all ui-widget ui-button-icon-only ' >\n            <span class=\"ui-icon ui-icon-minus\"></span>\n        </button>\n    </form></td>\n</tr>";
  };

  FilmListView.prototype.initXEditableFields = function() {
    var film, i, len, ref, results;
    $.fn.editable.defaults.mode = 'inline';
    ref = this.filmList.getCollection();
    results = [];
    for (i = 0, len = ref.length; i < len; i++) {
      film = ref[i];
      $("#" + film.id + "_title").editable();
      $("#" + film.id + "_director").editable();
      $("#" + film.id + "_year").editable();
      $("#" + film.id + "_runtime").editable();
      results.push($("#" + film.id + "_fsk").editable());
    }
    return results;
  };

  FilmListView.prototype.addDeleteEvents = function() {
    var film, i, len, ref, results;
    ref = this.filmList.getCollection();
    results = [];
    for (i = 0, len = ref.length; i < len; i++) {
      film = ref[i];
      results.push($("#" + film.id).on('click', (function(_this) {
        return function(event) {
          return _this.deleteFilm(event, _this.render);
        };
      })(this)));
    }
    return results;
  };

  FilmListView.prototype.checkInputFields = function(values) {
    var isNotEmpty, k, v;
    isNotEmpty = true;
    for (k in values) {
      v = values[k];
      if (!v) {
        isNotEmpty = false;
      }
    }
    return isNotEmpty;
  };

  FilmListView.prototype.readInputFields = function() {
    var values;
    values = {};
    values.title = $(this.inputTitle).val();
    values.director = $(this.inputDirector).val();
    values.year = $(this.inputYear).val();
    values.runtime = $(this.inputRuntime).val();
    values.fsk = $(this.inputFsk).val();
    return values;
  };

  FilmListView.prototype.createFilm = function(event, callback) {
    var created, valid, values;
    values = this.readInputFields();
    valid = this.checkInputFields(values);
    if (valid) {
      created = this.filmList.newFilm(values, callback);
      if (!created) {
        $("#dialog-already-exist").dialog("open");
      }
    } else {
      $("#dialog-invalid-input").dialog("open");
    }
    return this;
  };

  FilmListView.prototype.createOnEnter = function(event, callback) {
    if (event.keyCode === 13) {
      return this.createFilm(event, callback);
    }
  };

  FilmListView.prototype.deleteFilm = function(event, callback) {
    this.filmList.removeFilm(event.currentTarget.id, callback);
    return this;
  };

  FilmListView.prototype.saveFilmList = function(event, callback) {
    $(this.classNotSaved).each((function(_this) {
      return function(k, v) {
        var newV;
        newV = v.id.split("_");
        return _this.filmList.updateFilm(newV[0], newV[1], v.innerText);
      };
    })(this));
    this.filmList.save(callback);
    return this;
  };

  FilmListView.prototype.sort = function(event, callback) {
    var sorting, val;
    sorting = "asc";
    val = event.currentTarget.id.replace("sort", "");
    val = val.toLowerCase();
    if (this.sorted[0] === '#' + event.currentTarget.id) {
      if (this.sorted[1] === "sort-" + sorting) {
        sorting = "desc";
      }
    }
    this.filmList.sort(val, sorting);
    this.sorted = ['#' + event.currentTarget.id, "sort-" + sorting];
    if (typeof callback === "function") {
      callback();
    }
    return this;
  };

  FilmListView.prototype.isDataSaved = function() {
    return $('.editable-unsaved').length <= 0;
  };

  FilmListView.prototype.showDialogSave = function(arg, event) {
    var dynamicButton;
    this.arg = arg;
    if (!this.isDataSaved()) {
      dynamicButton = {
        "Save and continue": (function(_this) {
          return function() {
            _this.saveFilmList(event, _this.render);
            _this.arg(event, _this.render);
            return $("#dialog-eidtable-not-saved").dialog("close");
          };
        })(this),
        "No Save and continue": (function(_this) {
          return function() {
            _this.arg(event, _this.render);
            return $("#dialog-eidtable-not-saved").dialog("close");
          };
        })(this)
      };
      $("#dialog-eidtable-not-saved").dialog("option", "buttons", dynamicButton);
      return $("#dialog-eidtable-not-saved").dialog("open");
    } else {
      return this.arg(event, this.render);
    }
  };

  return FilmListView;

})();

filmList = new FilmList();

app = new FilmListView(filmList);
